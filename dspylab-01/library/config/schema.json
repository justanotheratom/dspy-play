{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://dspylab.org/schemas/experiment.schema.json",
  "title": "DSPyLab Experiment Configuration",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "experiment_name",
    "program",
    "models",
    "matrix",
    "dataset",
    "outputs"
  ],
  "definitions": {
    "identifier": {
      "type": "string",
      "minLength": 1,
      "pattern": "^[A-Za-z0-9_.-]+$"
    },
    "stringMap": {
      "type": "object",
      "additionalProperties": {
        "type": "string",
        "minLength": 1
      }
    },
    "params": {
      "type": "object",
      "additionalProperties": true
    },
    "metricRefs": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true
    },
    "priceRate": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "usd_per_1m": {
          "type": "number",
          "minimum": 0
        }
      },
      "required": ["usd_per_1m"]
    },
    "pricingOverride": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "input": {"$ref": "#/definitions/priceRate"},
        "cached_input": {"$ref": "#/definitions/priceRate"},
        "output": {"$ref": "#/definitions/priceRate"}
      }
    },
    "pricingReference": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "pricing_id": {"type": "string", "minLength": 1},
        "price_version": {"type": "integer", "minimum": 1},
        "override": {"$ref": "#/definitions/pricingOverride"},
        "fine_tuned": {"type": "boolean"}
      },
      "required": ["pricing_id"]
    },
    "pricingLegacy": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "input_per_1k": {"type": "number", "minimum": 0},
        "cached_input_per_1k": {"type": "number", "minimum": 0},
        "output_per_1k": {"type": "number", "minimum": 0}
      }
    },
    "pricing": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "reference": {"$ref": "#/definitions/pricingReference"},
        "legacy": {"$ref": "#/definitions/pricingLegacy"}
      },
      "oneOf": [
        {"required": ["reference"]},
        {"required": ["legacy"]}
      ]
    },
    "budget": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "max_usd": {"type": "number", "minimum": 0},
        "warn_usd": {"type": "number", "minimum": 0},
        "max_train_usd": {"type": "number", "minimum": 0},
        "max_infer_usd": {"type": "number", "minimum": 0}
      },
      "required": ["max_usd"]
    }
  },
  "properties": {
    "experiment_name": {
      "$ref": "#/definitions/identifier"
    },
    "description": {
      "type": "string"
    },
    "tags": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "uniqueItems": true
    },
    "program": {
      "type": "object",
      "required": ["module", "factory"],
      "additionalProperties": false,
      "properties": {
        "module": {"type": "string", "minLength": 1},
        "factory": {"type": "string", "minLength": 1},
        "dataset_loader": {"type": "string", "minLength": 1},
        "metrics": {"$ref": "#/definitions/stringMap"},
        "extras": {"$ref": "#/definitions/params"},
        "estimated_calls_per_example": {"type": "number", "minimum": 0},
        "estimated_training_calls": {"type": "number", "minimum": 0}
      }
    },
    "models": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "provider", "model", "api_key_env"],
        "additionalProperties": false,
        "properties": {
          "id": {"$ref": "#/definitions/identifier"},
          "provider": {"type": "string", "minLength": 1},
          "model": {"type": "string", "minLength": 1},
          "api_key_env": {"type": "string", "minLength": 1},
          "temperature": {"type": "number", "minimum": 0, "maximum": 2},
          "max_output_tokens": {"type": "integer", "minimum": 1},
          "pricing": {"$ref": "#/definitions/pricing"},
          "cache": {"type": "boolean"}
        }
      }
    },
    "optimizers": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "type"],
        "additionalProperties": false,
        "properties": {
          "id": {"$ref": "#/definitions/identifier"},
          "type": {"type": "string", "minLength": 1},
          "params": {"$ref": "#/definitions/params"},
          "metrics": {"$ref": "#/definitions/metricRefs"}
        }
      }
    },
    "matrix": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["model"],
        "additionalProperties": false,
        "properties": {
          "name": {"$ref": "#/definitions/identifier"},
          "model": {"$ref": "#/definitions/identifier"},
          "optimizer": {"$ref": "#/definitions/identifier"},
          "metrics": {"$ref": "#/definitions/metricRefs"},
          "overrides": {"$ref": "#/definitions/params"}
        }
      }
    },
    "dataset": {"type": "object", "required": ["source", "path"], "additionalProperties": false,
      "properties": {
        "source": {"type": "string", "minLength": 1},
        "path": {"type": "string", "minLength": 1},
        "split": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "dev_ratio": {"type": "number", "minimum": 0, "maximum": 1},
            "seed": {"type": "integer"}
          }
        }
      }
    },
    "outputs": {
      "type": "object",
      "required": ["root_dir"],
      "additionalProperties": false,
      "properties": {
        "root_dir": {"type": "string", "minLength": 1},
        "raw_filename": {"type": "string", "minLength": 1},
        "summary_filename": {"type": "string", "minLength": 1}
      }
    },
    "logging": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "level": {"type": "string", "enum": ["debug", "info", "warning", "error", "critical"]},
        "verbose": {"type": "boolean"}
      }
    },
    "budget": {"$ref": "#/definitions/budget"}
  }
}

